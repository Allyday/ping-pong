<!DOCTYPE html>
<html>

<head>
	<title>Ping Pong Game</title>
	<link rel="icon" href="https://i.imgur.com/frnLhAS.png">
</head>

<body>
	<canvas id="canvas" width="800" height="400"></canvas>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript" src="js/constants.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="module">
		import { Ball } from './js/Ball.js';
		import { CanvasNode } from './js/CanvasNode.js';

		const state = { p1: '', p2: '', is: '' };

		app.onInit = function () {
			document.body.style.margin = "0px";

			this.reset();

			document.addEventListener('keydown', event => {
				if (event.code === 'KeyW') state.p1 = CONST.up;
				if (event.code === 'KeyS') state.p1 = CONST.down;
				if (event.code === 'ArrowUp') state.p2 = CONST.up;
				if (event.code === 'ArrowDown') state.p2 = CONST.down;
				if (event.code === 'Space') {
					const ball = this.getNode(CONST.ball);
					const p1 = this.getNode(CONST.player1);
					const p2 = this.getNode(CONST.player2);

					if (state.is !== CONST.PLAYING) this.start();
					else this.pause();
					switchColors(state.is, ball, p1, p2);
				}
			}, false);

			document.addEventListener('keyup', event => {
				if (event.code === 'KeyW' || event.code === 'KeyS') state.p1 = '';
				if (event.code === 'ArrowUp' || event.code === 'ArrowDown') state.p2 = '';
			})
		};

		app.onUpdate = function (time) {
			const ball = this.getNode(CONST.ball);
			const p1 = this.getNode(CONST.player1);
			const p2 = this.getNode(CONST.player2);
			const up = { x: 0, y: -1 };
			const down = { x: 0, y: 1 };

			if (state.is !== CONST.PLAYING) return;

			if (state.p1 === CONST.up && !p1.hitsCeiling())
				p1.moves(up);
			else if (state.p1 === CONST.down && !p1.hitsFloor(this.canvas))
				p1.moves(down);

			if (state.p2 === CONST.up && !p2.hitsCeiling())
				p2.moves(up);
			else if (state.p2 === CONST.down && !p2.hitsFloor(this.canvas))
				p2.moves(down);

			if (ball.collidesWith(p1)) {
				ball.bouncesFrom(p1);
				this.accelerate();
			} else if (ball.collidesWith(p2)) {
				ball.bouncesFrom(p2);
				this.accelerate();
			} else if (ball.hitsFloor(this.canvas) || ball.hitsCeiling()) {
				/* ball bounces off ceiling & floor */
				ball.angle *= -1;
			} else if (ball.x + ball.width >= this.width) {
				console.log('Player 1 wins!!');
				this.reset();
			} else if (ball.x < 0) {
				console.log('Player 2 wins!!');
				this.reset();
			}
			const vector = calcMovementVector(ball.angle);

			ball.moves(vector, { leftLimit: p1, rightLimit: p2 });
		};

		app.reset = function () {
			this.canvas.width = window.innerWidth;
			this.canvas.height = window.innerHeight;
			this.width = canvas.width;
			this.height = canvas.height;

			this.clear();
			this.nodes = [];
			state.is = CONST.NEW_GAME;

			const p1 = new CanvasNode(
				CONST.player1,
				this.width * CONST.playerPadding,
				this.height * (1 - CONST.playerHeight) / 2,
				this.width * CONST.playerWidth,
				this.height * CONST.playerHeight,
				'#777',
				CONST.initialPlayerVelocity,
			);

			const p2 = new CanvasNode(
				CONST.player2,
				this.width * (1 - CONST.playerWidth - CONST.playerPadding), // far right
				this.height * (1 - CONST.playerHeight) / 2,
				this.width * CONST.playerWidth,
				this.height * CONST.playerHeight,
				'#777',
				CONST.initialPlayerVelocity,
			);

			const ball = new Ball(
				CONST.ball,
				this.canvas,
				CONST.ballSize,
				'#ccc',
				CONST.maxBounceAngle,
				CONST.initialBallVelocity,
			);

			this.nodes.push(ball, p1, p2);
		}

		app.pause = function () {
			state.is = CONST.PAUSED;
		}

		app.start = function () {
			state.is = CONST.PLAYING;
		}

		app.accelerate = function () {
			this.nodes.forEach(node => {
				if (node.velocity) {
					node.accelerate(CONST.acceleration);
				}
			})
		}
	</script>
</body>

</html>