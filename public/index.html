<!DOCTYPE html>
<html>

<head>
	<title>Ping Pong Game</title>
	<link rel="icon" href="https://i.imgur.com/frnLhAS.png">
</head>

<body>
	<canvas id="canvas" width="800" height="400"></canvas>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript" src="js/constants.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="module">
		import { Ball } from './js/Ball.js';

		const state = { p1: '', p2: '', ballVelocity: 8, playerVelocity: 8, is: '' };

		app.onInit = function () {
			document.body.style.margin = "0px";

			this.reset();

			document.addEventListener('keydown', event => {
				if (event.code === 'KeyW') state.p1 = CONST.up;
				if (event.code === 'KeyS') state.p1 = CONST.down;
				if (event.code === 'ArrowUp') state.p2 = CONST.up;
				if (event.code === 'ArrowDown') state.p2 = CONST.down;
				if (event.code === 'Space') {
					const ball = this.getNode(CONST.ball);
					const p1 = this.getNode(CONST.player1);
					const p2 = this.getNode(CONST.player2);

					if (state.is !== CONST.PLAYING) this.start();
					else this.pause();
					switchColors(state.is, ball, p1, p2);
				}
			}, false);

			document.addEventListener('keyup', event => {
				if (event.code === 'KeyW' || event.code === 'KeyS') state.p1 = '';
				if (event.code === 'ArrowUp' || event.code === 'ArrowDown') state.p2 = '';
			})
		};

		app.onUpdate = function (time) {
			const ball = this.getNode(CONST.ball);
			const p1 = this.getNode(CONST.player1);
			const p2 = this.getNode(CONST.player2);

			if (!ball.angle || !state.ballVelocity || state.is !== CONST.PLAYING) return;

			if (state.p1 === CONST.up && p1.y > 0) {
				p1.y -= state.playerVelocity;
			} else if (state.p1 === CONST.down && p1.y + p1.height < this.height) {
				p1.y += state.playerVelocity;
			}

			if (state.p2 === CONST.up && p2.y > 0) {
				p2.y -= state.playerVelocity;
			} else if (state.p2 === CONST.down && p2.y + p2.height < this.height) {
				p2.y += state.playerVelocity;
			}

			const ballIsWithinP1Height = (ball.y >= p1.y - ball.height) && (ball.y <= p1.y + p1.height);
			const ballIsWithinP2Height = (ball.y >= p2.y - ball.height) && (ball.y <= p2.y + p2.height);

			if ((ball.x == p1.x + p1.width) && ballIsWithinP1Height) {
				/* how far is the collision from the center */
				const relativeHeightDiff = (p1.y + (p1.height / 2)) - ball.y;
				const bounceIntensity = relativeHeightDiff / (p1.height / 2);
				const bounceAngle = bounceIntensity * CONST.maxBounceAngle;
				state.ballVelocity *= CONST.acceleration; // accelerate to make the game fun
				state.playerVelocity *= CONST.acceleration;
				ball.angle = bounceAngle;
			} else if ((ball.x == p2.x - ball.width) && ballIsWithinP2Height) {
				const relativeHeightDiff = (p2.y + (p2.height / 2)) - ball.y;
				const bounceIntensity = relativeHeightDiff / (p2.height / 2);
				const bounceAngle = bounceIntensity * CONST.maxBounceAngle;
				state.ballVelocity *= CONST.acceleration;
				state.playerVelocity *= CONST.acceleration;
				ball.angle = Math.PI - bounceAngle;
			} else if (ball.y > this.height - ball.height || ball.y < 0) {
				/* ball bounces off ceiling & floor */
				ball.angle *= -1;
			} else if (ball.x + ball.width >= this.width) {
				console.log('Player 1 wins!!');
				this.reset();
			} else if (ball.x < 0) {
				console.log('Player 2 wins!!');
				this.reset();
			}

			const vector = calcMovementVector(ball.angle);
			let newX;
			const calculatedNewX = ball.x + vector.x * state.ballVelocity;
			/* prevent ball & paddle overlap when collide */
			if (vector.x < 0 && ballIsWithinP1Height)
				newX = Math.max(calculatedNewX, p1.x + p1.width);
			else if (vector.x > 0 && ballIsWithinP2Height)
				newX = Math.min(calculatedNewX, p2.x - ball.width);
			else newX = calculatedNewX;
			ball.x = newX;
			ball.y += vector.y * state.ballVelocity;
		};

		app.reset = function () {
			this.canvas.width = window.innerWidth;
			this.canvas.height = window.innerHeight;
			this.width = canvas.width;
			this.height = canvas.height;

			this.clear();
			this.nodes = [];
			state.is = CONST.NEW_GAME;
			state.ballVelocity = 8;
			state.playerVelocity = 8;

			const p1 = {
				id: CONST.player1,
				x: this.width * CONST.playerPadding,
				y: this.height * (1 - CONST.playerHeight) / 2,
				width: this.width * CONST.playerWidth,
				height: this.height * CONST.playerHeight,
			};

			const p2 = {
				id: CONST.player2,
				x: this.width * (1 - CONST.playerWidth - CONST.playerPadding), // far right
				y: this.height * (1 - CONST.playerHeight) / 2,
				width: this.width * CONST.playerWidth,
				height: this.height * CONST.playerHeight,
			};

			const ball = new Ball(CONST.ball, this.canvas, CONST.ballSize, '#ccc');
			this.nodes.push(ball, p1, p2);
			switchColors(state.is, ball, p1, p2);
		}

		app.pause = function () {
			state.is = CONST.PAUSED;
		}

		app.start = function () {
			state.is = CONST.PLAYING;
		}
	</script>
</body>

</html>