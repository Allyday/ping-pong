<!DOCTYPE html>
<html>

<head>
	<title>Ping Pong Game</title>
</head>

<body>
	<canvas id="canvas" width="800" height="400"></canvas>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript">
		const CONST = {
			player1: 'player-1',
			player2: 'player-2',
			ball: 'ball',
			playerWidth: 0.015,
			playerHeight: 0.2,
			playerPadding: 0.005,
			ballSize: 0.01,
			up: 'up',
			down: 'down',
			maxBounceAngle: 5 * Math.PI / 12, // 75 degrees
			acceleration: 1.1,
		}

		const state = { p1: '', p2: '', ballVelocity: 8, playerVelocity: 8 };

		app.onInit = function () {
			document.body.style.margin = "0px";
			const canvas = document.getElementById("canvas");
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			this.width = canvas.width;
			this.height = canvas.height;

			this.nodes.push({
				id: CONST.player1,
				x: app.width * CONST.playerPadding,
				y: app.height * (1 - CONST.playerHeight) / 2,
				width: app.width * CONST.playerWidth,
				height: app.height * CONST.playerHeight,
				color: '#e22a32',
			});

			this.nodes.push({
				id: CONST.player2,
				x: app.width * (1 - CONST.playerWidth - CONST.playerPadding), // far right
				y: app.height * (1 - CONST.playerHeight) / 2,
				width: app.width * CONST.playerWidth,
				height: app.height * CONST.playerHeight,
				color: '#37595b',
			});

			this.nodes.push({
				id: CONST.ball,
				x: app.width / 2,
				y: app.height / 2,
				width: app.width * CONST.ballSize,
				height: app.width * CONST.ballSize,
				color: '#f8d212',
				angle: Math.random() * Math.PI / 2 - Math.PI / 4,
			});

			document.addEventListener('keydown', event => {
				if (event.code === 'KeyW') state.p1 = CONST.up;
				if (event.code === 'KeyS') state.p1 = CONST.down;
				if (event.code === 'ArrowUp') state.p2 = CONST.up;
				if (event.code === 'ArrowDown') state.p2 = CONST.down;
			}, false);

			document.addEventListener('keyup', event => {
				if (event.code === 'KeyW' || event.code === 'KeyS') state.p1 = '';
				if (event.code === 'ArrowUp' || event.code === 'ArrowDown') state.p2 = '';
			})

		};

		app.onUpdate = function (time) {
			const ball = this.getNode(CONST.ball);
			const p1 = this.getNode(CONST.player1);
			const p2 = this.getNode(CONST.player2);

			if (!ball.angle || !state.ballVelocity) return;

			if (state.p1 === CONST.up && p1.y > 0) {
				p1.y -= state.playerVelocity;
			} else if (state.p1 === CONST.down && p1.y + p1.height < app.height) {
				p1.y += state.playerVelocity;
			}

			if (state.p2 === CONST.up && p2.y > 0) {
				p2.y -= state.playerVelocity;
			} else if (state.p2 === CONST.down && p2.y + p2.height < app.height) {
				p2.y += state.playerVelocity;
			}

			const ballIsWithinP1Height = (ball.y >= p1.y - ball.height) && (ball.y <= p1.y + p1.height);
			const ballIsWithinP2Height = (ball.y >= p2.y - ball.height) && (ball.y <= p2.y + p2.height);

			if ((ball.x == p1.x + p1.width) && ballIsWithinP1Height) {
				/* how far is the collision from the center */
				const relativeHeightDiff = (p1.y + (p1.height / 2)) - ball.y;
				const bounceIntensity = relativeHeightDiff / (p1.height / 2);
				const bounceAngle = bounceIntensity * CONST.maxBounceAngle;
				state.ballVelocity *= CONST.acceleration; // accelerate to make the game fun
				state.playerVelocity *= CONST.acceleration;
				ball.angle = bounceAngle;
			} else if ((ball.x == p2.x - ball.width) && ballIsWithinP2Height) {
				const relativeHeightDiff = (p2.y + (p2.height / 2)) - ball.y;
				const bounceIntensity = relativeHeightDiff / (p2.height / 2);
				const bounceAngle = bounceIntensity * CONST.maxBounceAngle;
				state.ballVelocity *= CONST.acceleration;
				state.playerVelocity *= CONST.acceleration;
				ball.angle = Math.PI - bounceAngle;
			} else if (ball.y > app.height - ball.height || ball.y < 0) {
				/* ball bounces off ceiling & floor */
				ball.angle *= -1;
			} else if (ball.x + ball.width >= app.width) {
				state.ballVelocity = 0;
				console.log('Player 1 wins!!');
			} else if (ball.x < 0) {
				state.ballVelocity = 0;
				console.log('Player 2 wins!!');
			}

			const vector = calcMovementVector(ball.angle);
			let newX;
			const calculatedNewX = ball.x + vector.x * state.ballVelocity;
			/* prevent ball & paddle overlap when collide */
			if (vector.x < 0 && ballIsWithinP1Height)
				newX = Math.max(calculatedNewX, p1.x + p1.width);
			else if (vector.x > 0 && ballIsWithinP2Height)
				newX = Math.min(calculatedNewX, p2.x - ball.width);
			else newX = calculatedNewX;
			ball.x = newX;
			ball.y += vector.y * state.ballVelocity;
		};

		function calcMovementVector(angle) {
			return {
				x: Math.cos(angle),
				y: Math.sin(angle),
			};
		}

	</script>
</body>

</html>